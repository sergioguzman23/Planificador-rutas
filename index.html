<!--
© 2025 Sergio R. Guzmán – Todos los derechos reservados
Este software es propiedad de su autor. Queda prohibida su copia, distribución o modificación
sin autorización expresa.
-->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador de Rutas con Google Maps</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ESTILOS PARA EL LOGIN */
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }
    
    .login-box {
      width: 100%;
      max-width: 450px;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      padding: 30px;
      text-align: center;
    }
    
    .login-header {
      margin-bottom: 30px;
    }
    
    .login-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-header h1 {
      font-size: 2rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .login-header p {
      color: #7f8c8d;
      font-size: 1.1rem;
    }
    
    .login-form {
      text-align: left;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s;
    }
    
    .form-group input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .login-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(90deg, #3498db, #2c3e50);
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }
    
    .login-btn:active {
      transform: translateY(0);
    }
    
    .login-btn i {
      margin-right: 12px;
    }
    
    .validation-message {
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
      font-size: 0.9rem;
    }
    
    .validation-error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
    
    .login-footer {
      margin-top: 25px;
      color: #7f8c8d;
      font-size: 0.9rem;
    }
    
    .hidden {
      display: none;
    }

    /* ESTILOS PARA LA APLICACIÓN PRINCIPAL */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%); color: #333; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
    .container { width: 100%; max-width: 1400px; background: rgba(255, 255, 255, 0.97); border-radius: 20px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25); overflow: hidden; }
    
    header { 
      background: linear-gradient(90deg, #3498db, #2c3e50); 
      color: white; 
      padding: 0 25px; 
      display: flex; 
      align-items: center; 
      justify-content: flex-start;
      height: 120px;
    }
    header img.logo { 
      height: 100%; 
      width: auto; 
      margin-right: 20px; 
    }
    
    h1 { font-size: 2.2rem; margin-bottom: 10px; font-weight: 700; }
    .subtitle { font-size: 1.1rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
    
    .app-content { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .controls-section { display: flex; flex-direction: column; gap: 25px; }
    .input-section { background: #f8f9fa; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
    h2 { font-size: 1.5rem; margin-bottom: 18px; color: #2c3e50; display: flex; align-items: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    h2 i { margin-right: 12px; color: #3498db; }
    .input-group { display: flex; margin-bottom: 15px; }
    input[type="text"] { flex: 1; padding: 14px; border: 2px solid #ddd; border-radius: 10px 0 0 10px; font-size: 1rem; outline: none; transition: all 0.3s; }
    input[type="text"]:focus { border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
    button { padding: 14px 18px; border: none; border-radius: 0 10px 10px 0; background: #3498db; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    button:hover { background: #2980b9; transform: translateY(-2px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .file-upload { display: flex; align-items: center; margin-top: 15px; padding: 15px; background: #e8f4fc; border-radius: 10px; border: 2px dashed #3498db; }
    .file-upload button { border-radius: 10px; margin-left: 10px; background: #2c3e50; }
    .file-upload button:hover { background: #1a252f; }
    .directions-list { max-height: 250px; overflow-y: auto; margin: 18px 0; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0; }
    .direction-item { padding: 12px 16px; margin-bottom: 10px; background: #f8f9fa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; border-left: 4px solid #3498db; }
    .direction-item:hover { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .direction-item .address-text { flex: 1; margin-right: 15px; }
    .direction-item .remove-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .direction-item .remove-btn:hover { background: #c0392b; transform: scale(1.1); }
    .action-buttons { display: grid; grid-template-columns: 1fr; gap: 15px; margin: 25px 0; }
    .action-buttons button { border-radius: 12px; padding: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .action-buttons button i { margin-right: 12px; }
    .calculate-btn { background: linear-gradient(90deg, #f39c12, #e67e22); }
    .calculate-btn:hover { background: linear-gradient(90deg, #e67e22, #d35400); }
    .navigate-btn { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .navigate-btn:hover { background: linear-gradient(90deg, #2ecc71, #27ae60); }
    .map-section { display: flex; flex-direction: column; gap: 15px; }
    .map-container { height: 400px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 3px solid #2c3e50; }
    #map { height: 100%; width: 100%; }
    .route-info { margin-top: 15px; padding: 20px; background: #f8f9fa; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
    .route-info h3 { margin-bottom: 15px; color: #2c3e50; display: flex; align-items: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .route-info h3 i { margin-right: 10px; color: #3498db; }
    #routeDetails { line-height: 1.6; }
    .stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .stat { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); }
    .stat h4 { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px; }
    .stat p { font-size: 1.4rem; font-weight: 700; color: #2c3e50; }
    .loading { display: none; text-align: center; padding: 30px; background: rgba(255, 255, 255, 0.9); border-radius: 15px; margin: 20px 0; }
    .loading i { font-size: 2.5rem; color: #3498db; margin-bottom: 15px; }
    .loading p { font-size: 1.2rem; color: #2c3e50; }
    .validation-success { background: #d4edda; color: #155724; display: block; }
    footer { text-align: center; padding: 15px; background: #2c3e50; color: white; font-size: 0.9rem; }
    footer a { color: #f1c40f; text-decoration: none; font-weight: bold; }
    footer a:hover { text-decoration: underline; }
    @media (max-width: 900px) { .app-content { grid-template-columns: 1fr; } .map-container { height: 350px; } }
    @media (max-width: 600px) { .input-group { flex-direction: column; } input[type="text"] { border-radius: 10px; margin-bottom: 10px; } button { border-radius: 10px; } .file-upload { flex-direction: column; gap: 10px; } .file-upload button { margin-left: 0; } .stats-box { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Contenedor de Login -->
  <div class="login-container" id="login-container">
    <div class="login-box">
      <div class="login-header">
        <div class="login-logo" style="background:none; box-shadow:none;">
          <img src="logo 2.png" alt="Logo Ciudad SMT" style="width:120px; height:120px; object-fit:contain;" />
        </div>
        <h1>Planificador de Rutas</h1>
        <p>Tribunal Municipal de Faltas - San Miguel de Tucumán</p>
      </div>
      
      <div class="login-form">
        <div class="form-group">
          <label for="username"><i class="fas fa-user"></i> Usuario</label>
          <input type="text" id="username" placeholder="Ingrese su usuario">
        </div>
        
        <div class="form-group">
          <label for="password"><i class="fas fa-lock"></i> Contraseña</label>
          <input type="password" id="password" placeholder="Ingrese su contraseña">
        </div>
        
        <div id="login-validation" class="validation-message"></div>
        
        <button id="login-btn" class="login-btn">
          <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
        </button>
      </div>
      
      <div class="login-footer">
        <p>Desarrollado por Sergio R. Guzman</p>
      </div>
    </div>
  </div>

  <!-- Contenedor de la aplicación (oculto inicialmente) -->
  <div class="container hidden" id="app-container">
    <header>
      <img src="logo 2.png" alt="Logo Ciudad SMT" class="logo" />
      <div>
        <h1>Planificador de Rutas para Notificadores</h1>
        <p class="subtitle">Tribunal Municipal de Faltas - Municipalidad de San Miguel de Tucumán</p>
      </div>
    </header>
<div class="app-content">
      <div class="controls-section">
        <div class="input-section">
          <h2><i class="fas fa-map-marker-alt"></i> Punto de Partida</h2>
          <div class="input-group">
            <input type="text" id="startPoint" placeholder="Ej: Jujuy 259, San Miguel de Tucumán" />
            <button id="setStartPoint"><i class="fas fa-check"></i> Establecer</button>
          </div>
          <div id="startPointValidation" class="validation-message"></div>
        </div>

        <div class="input-section">
          <h2><i class="fas fa-road"></i> Direcciones a Visitar</h2>
          <div class="input-group">
            <input type="text" id="newAddress" placeholder="Ingrese una dirección" />
            <button id="addAddress"><i class="fas fa-plus"></i> Agregar</button>
          </div>
          <div id="addressValidation" class="validation-message"></div>

          <div class="file-upload">
            <span>O cargue desde archivo (máx. 30 direcciones)</span>
            <button id="uploadFile"><i class="fas fa-upload"></i> Seleccionar Archivo</button>
            <input type="file" id="fileInput" accept=".txt,.csv" style="display: none" />
          </div>

          <div class="directions-list" id="directionsList">
            <p>No hay direcciones agregadas. Ingrese direcciones manualmente o cargue un archivo.</p>
          </div>
        </div>

        <div class="action-buttons">
          <button class="calculate-btn" id="calculateRoute"><i class="fas fa-route"></i> Calcular Ruta Óptima</button>
          <button class="navigate-btn" id="startNavigation" disabled title="Calculá una ruta primero"><i class="fas fa-play"></i> Comenzar Navegación</button>
        </div>

        <div class="route-info">
          <h3><i class="fas fa-info-circle"></i> Información de Ruta</h3>
          <div id="routeDetails">Esperando cálculo de ruta...</div>
          <div class="stats-box">
            <div class="stat"><h4>Distancia Total</h4><p id="totalDistance">-</p></div>
            <div class="stat"><h4>Tiempo Estimado</h4><p id="totalTime">-</p></div>
          </div>
        </div>
      </div>

      <div class="map-section">
        <h2><i class="fas fa-map-marked-alt"></i> Mapa de Google Maps</h2>
        <p>Verifica que las direcciones se muestren correctamente en el mapa</p>
        <div class="map-container"><div id="map"></div></div>
        <div class="route-info">
          <h3><i class="fas fa-list-ol"></i> Orden de Visitas</h3>
          <ol id="routeSteps"><li>La ruta optimizada se mostrará aquí después del cálculo</li></ol>
        </div>
      </div>
    </div>

    <div class="loading" id="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Calculando la ruta óptima...</p>
    </div>

    <footer>
      Desarrollado por <a href="mailto:sergioguzman23@gmail.com">Sergio R. Guzmán</a> para el Tribunal de Municipal de Faltas - @2025 Todos los derechos reservados
    </footer>
  </div>

  <script>
    // ========== SISTEMA DE LOGIN ==========
    // Datos de usuarios válidos
    const usuariosValidos = {
      "admin": { password: "admin123", nombre: "Administrador" },
      "notificador": { password: "notif123", nombre: "Notificador" },
      "sergio": { password: "sergio123", nombre: "Sergio Guzman" }
    };

    // Elementos del DOM para login
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginValidation = document.getElementById('login-validation');

    // Función para mostrar mensajes de validación
    function showValidation(el, message, type) {
      el.textContent = message;
      el.className = 'validation-message ' + (type === 'success' ? 'validation-success' : 'validation-error');
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transition = 'opacity 0.5s';
        setTimeout(() => { el.className = 'validation-message'; el.style.opacity = '1'; }, 500);
      }, 5000);
    }

    // Función para iniciar sesión
    function iniciarSesion() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!username || !password) {
        showValidation(loginValidation, 'Por favor complete todos los campos', 'error');
        return;
      }
      
      if (usuariosValidos[username] && usuariosValidos[username].password === password) {
        // Login exitoso
        showValidation(loginValidation, '✓ Acceso concedido. Redirigiendo...', 'success');
        
        // Ocultar login y mostrar aplicación después de un breve retraso
        setTimeout(() => {
          loginContainer.style.display = 'none';
          appContainer.classList.remove('hidden');
          document.title = "Planificador de Rutas con Google Maps";
        }, 1500);
      } else {
        // Credenciales incorrectas
        showValidation(loginValidation, 'Usuario o contraseña incorrectos', 'error');
        passwordInput.value = '';
      }
    }

    // Event listeners para el login
    loginBtn.addEventListener('click', iniciarSesion);
    
    // Permitir login con Enter
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        iniciarSesion();
      }
    });

    // ========== APLICACIÓN PRINCIPAL ==========
    let map, mapsReadyResolve;
    let startPoint = null;
    let addresses = []; // { address, coords: {lat, lng} }
    let markers = []; // first marker reserved for start
    let directionsService, directionsRenderer;
    let lastDirectionsResult = null; // guardamos la última respuesta calculada

    // API Key fija
    const API_KEY = 'AIzaSyDZmVOS6HGaO_74YYAgCTUrE8bW_cp7_FU';

    // ---------- Utilidades ----------
    function isMapsReady() {
      return !!(window.google && google.maps && google.maps.Geocoder);
    }

    function enableControls() {
      // Todos los controles ya están habilitados por defecto
      console.log('Controles habilitados');
    }

    function disableNavigation() {
      document.getElementById('startNavigation').disabled = true;
    }

    function updateDirectionsList() {
      const list = document.getElementById('directionsList');
      list.innerHTML = '';
      if (addresses.length === 0) {
        list.innerHTML = '<p>No hay direcciones agregadas. Ingrese direcciones manualmente o cargue un archivo.</p>';
        return;
      }
      addresses.forEach((addr, index) => {
        const div = document.createElement('div');
        div.className = 'direction-item';
        div.innerHTML = `
          <span class="address-text">${index + 1}. ${addr.address}</span>
          <button class="remove-btn" data-index="${index}" title="Quitar"><i class="fas fa-times"></i></button>
        `;
        list.appendChild(div);
      });
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const idx = parseInt(this.getAttribute('data-index'));
          // eliminar marcador correspondiente (+1 por el start)
          if (markers[idx + 1]) { markers[idx + 1].setMap(null); markers.splice(idx + 1, 1); }
          addresses.splice(idx, 1);
          updateDirectionsList();
          updateRouteDetails();
          lastDirectionsResult = null;
          disableNavigation();
          if (directionsRenderer) {
            directionsRenderer.setDirections({ routes: [] });
          }
        });
      });
    }

    function updateRouteDetails() {
      const routeDetails = document.getElementById('routeDetails');
      const totalDistanceEl = document.getElementById('totalDistance');
      const totalTimeEl = document.getElementById('totalTime');
      const routeSteps = document.getElementById('routeSteps');

      if (!startPoint && addresses.length === 0) {
        routeDetails.innerHTML = 'Esperando cálculo de ruta...';
        totalDistanceEl.textContent = '-';
        totalTimeEl.textContent = '-';
        routeSteps.innerHTML = '<li>La ruta optimizada se mostrará aquí después del cálculo</li>';
        return;
      }
      routeDetails.innerHTML = `
        <p><strong>Punto de partida:</strong> ${startPoint ? startPoint.address : 'No establecido'}</p>
        <p><strong>Destinos agregados:</strong> ${addresses.length}</p>
      `;
    }

    // ---------- Carga dinámica de Google Maps ----------
    function loadGoogleMaps() {
      if (isMapsReady()) return; // ya cargado
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=geometry`;
      script.async = true; script.defer = true;
      document.head.appendChild(script);
    }

    // callback global requerido por Google
    window.initMap = function () {
      const initialLocation = { lat: -26.8083, lng: -65.2176 };
      map = new google.maps.Map(document.getElementById('map'), { zoom: 13, center: initialLocation, mapTypeId: google.maps.MapTypeId.ROADMAP });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
      directionsRenderer.setMap(map);
      enableControls();
      if (typeof mapsReadyResolve === 'function') mapsReadyResolve();
      console.log('Google Maps cargado correctamente');
    };

    // ---------- App ----------
    document.addEventListener('DOMContentLoaded', function () {
      // Cargar Google Maps automáticamente después del login
      setTimeout(loadGoogleMaps, 1000);
      
      const setStartPointBtn = document.getElementById('setStartPoint');
      const addAddressBtn = document.getElementById('addAddress');
      const uploadFileBtn = document.getElementById('uploadFile');
      const fileInput = document.getElementById('fileInput');
      const calculateRouteBtn = document.getElementById('calculateRoute');
      const startNavigationBtn = document.getElementById('startNavigation');
      const loadingElement = document.getElementById('loading');
      const startPointValidation = document.getElementById('startPointValidation');
      const addressValidation = document.getElementById('addressValidation');

      // Helper: esperar a que Google Maps esté listo si aún no cargó
      function waitMapsReady() {
        if (isMapsReady()) return Promise.resolve();
        return new Promise(res => { mapsReadyResolve = res; });
      }

      // Punto de partida
      setStartPointBtn.addEventListener('click', async function () {
        await waitMapsReady();
        const address = document.getElementById('startPoint').value.trim();
        if (!address) { showValidation(startPointValidation, 'Por favor ingrese una dirección', 'error'); return; }
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address }, function (results, status) {
          if (status === 'OK' && results[0]) {
            if (markers[0]) { markers[0].setMap(null); }
            const loc = results[0].geometry.location;
            startPoint = { address, coords: { lat: loc.lat(), lng: loc.lng() } };
            const marker = new google.maps.Marker({ position: loc, map, title: 'Punto de Partida: ' + address, icon: { url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' } });
            markers[0] = marker;
            map.setCenter(loc);
            document.getElementById('startPoint').value = '';
            showValidation(startPointValidation, '✓ Punto de partida establecido correctamente. Verifique en el mapa.', 'success');
            updateRouteDetails();
            lastDirectionsResult = null;
            disableNavigation();
            if (directionsRenderer) {
              directionsRenderer.setDirections({ routes: [] });
            }
          } else {
            showValidation(startPointValidation, 'Error: No se pudo encontrar la dirección. Intente con una más específica.', 'error');
          }
        });
      });

      // Agregar dirección manual
      addAddressBtn.addEventListener('click', async function () {
        await waitMapsReady();
        const address = document.getElementById('newAddress').value.trim();
        if (!address) { showValidation(addressValidation, 'Por favor ingrese una dirección', 'error'); return; }
        if (addresses.length >= 30) { showValidation(addressValidation, 'Máximo 30 direcciones', 'error'); return; }
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address }, function (results, status) {
          if (status === 'OK' && results[0]) {
            const loc = results[0].geometry.location;
            addresses.push({ address, coords: { lat: loc.lat(), lng: loc.lng() } });
            const marker = new google.maps.Marker({ position: loc, map, title: address, icon: { url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' } });
            markers.push(marker);
            document.getElementById('newAddress').value = '';
            showValidation(addressValidation, '✓ Dirección agregada correctamente. Verifique en el mapa.', 'success');
            updateDirectionsList();
            updateRouteDetails();
            lastDirectionsResult = null;
            disableNavigation();
            if (directionsRenderer) {
              directionsRenderer.setDirections({ routes: [] });
            }
          } else if (status === 'OVER_QUERY_LIMIT') {
            showValidation(addressValidation, 'Límite de consultas alcanzado. Intenta de nuevo en unos segundos.', 'error');
          } else {
            showValidation(addressValidation, 'Error: No se pudo geocodificar la dirección.', 'error');
          }
        });
      });

      // Enter para agregar
      document.getElementById('newAddress').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') addAddressBtn.click();
      });

      // Cargar archivo (throttle simple)
      uploadFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', async function (e) {
        await waitMapsReady();
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (ev) {
          const lines = ev.target.result.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
          let idx = 0, ok = 0, bad = 0;
          const geocoder = new google.maps.Geocoder();
          function next() {
            if (idx >= lines.length || addresses.length >= 30) {
              updateDirectionsList(); updateRouteDetails();
              if (ok > 0) showValidation(addressValidation, `✓ Se agregaron ${ok} direcciones. ${bad ? bad + ' con error.' : ''}`, 'success');
              else showValidation(addressValidation, 'No se pudieron procesar direcciones del archivo.', 'error');
              return;
            }
            const address = lines[idx++];
            geocoder.geocode({ address }, function (results, status) {
              if (status === 'OK' && results[0]) {
                const loc = results[0].geometry.location;
                addresses.push({ address, coords: { lat: loc.lat(), lng: loc.lng() } });
                const marker = new google.maps.Marker({ position: loc, map, title: address, icon: { url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' } });
                markers.push(marker); ok++;
                setTimeout(next, 150); // throttle para evitar OVER_QUERY_LIMIT
              } else if (status === 'OVER_QUERY_LIMIT') {
                // backoff simple
                setTimeout(() => { idx--; next(); }, 800);
              } else { bad++; setTimeout(next, 50); }
            });
          }
          next();
        };
        reader.readAsText(file);
      });

      // Calcular ruta óptima usando optimizeWaypoints
      calculateRouteBtn.addEventListener('click', async function () {
        await waitMapsReady();
        if (!startPoint || addresses.length === 0) { alert('Establece un punto de partida y agrega direcciones primero'); return; }
        if (addresses.length > 23) { // límite típico de Waypoints para Directions API (origen+destino+23)
          alert('Google Directions API admite hasta 23 paradas intermedias. Reduce la lista o planifica en 2 tandas.');
          return;
        }
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        const waypoints = addresses.map(a => ({ location: new google.maps.LatLng(a.coords.lat, a.coords.lng), stopover: true }));
        const request = {
          origin: new google.maps.LatLng(startPoint.coords.lat, startPoint.coords.lng),
          destination: waypoints.length ? waypoints[waypoints.length - 1].location : new google.maps.LatLng(startPoint.coords.lat, startPoint.coords.lng),
          waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: true
        };

        directionsService.route(request, function (result, status) {
          loading.style.display = 'none';
          if (status === 'OK') {
            lastDirectionsResult = result;
            directionsRenderer.setDirections(result);
            renderRouteSummary(result);
            document.getElementById('startNavigation').disabled = false;
          } else {
            console.error('Error al calcular la ruta:', status);
            alert('No se pudo calcular la ruta. Código: ' + status);
          }
        });
      });

      // Resumen de ruta + pasos
      function renderRouteSummary(result) {
        const route = result.routes[0];
        const legs = route.legs;
        const totalDistanceEl = document.getElementById('totalDistance');
        const totalTimeEl = document.getElementById('totalTime');
        const routeDetails = document.getElementById('routeDetails');
        const routeStepsOl = document.getElementById('routeSteps');

        let meters = 0, seconds = 0;
        legs.forEach(l => { meters += l.distance.value; seconds += l.duration.value; });
        const km = (meters / 1000).toFixed(1);
        const h = Math.floor(seconds / 3600);
        const m = Math.round((seconds % 3600) / 60);

        totalDistanceEl.textContent = `${km} km`;
        totalTimeEl.textContent = `${h}h ${m}m`;
        routeDetails.innerHTML = `<p><strong>Ruta optimizada:</strong> ${legs.length} tramos</p><p><strong>Distancia total:</strong> ${km} km</p><p><strong>Tiempo estimado:</strong> ${h}h ${m}m</p>`;

        // Mostrar orden optimizado (usando waypoint_order)
        const order = route.waypoint_order || addresses.map((_, i) => i);
        routeStepsOl.innerHTML = '';
        const orderedStops = order.map(i => addresses[i]);
        const startLi = document.createElement('li');
        startLi.innerHTML = `<strong>Inicio:</strong> ${startPoint.address}`;
        startLi.style.fontWeight = 'bold';
        startLi.style.color = '#2ecc71';
        routeStepsOl.appendChild(startLi);
        orderedStops.forEach((s, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>Parada ${idx + 1}:</strong> ${s.address}`;
          routeStepsOl.appendChild(li);
        });
      }

      // Navegación real en Google Maps con el orden optimizado
      startNavigationBtn.addEventListener('click', function () {
        if (!lastDirectionsResult) { alert('Calcula la ruta primero.'); return; }
        const route = lastDirectionsResult.routes[0];
        const order = route.waypoint_order || addresses.map((_, i) => i);
        const orderedStops = order.map(i => addresses[i]);

        const origin = `${startPoint.coords.lat},${startPoint.coords.lng}`;
        const destination = `${orderedStops[orderedStops.length - 1].coords.lat},${orderedStops[orderedStops.length - 1].coords.lng}`;
        const waypointsParam = orderedStops.slice(0, -1).map(s => `${s.coords.lat},${s.coords.lng}`).join('|');

        const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}${waypointsParam ? `&waypoints=${encodeURIComponent(waypointsParam)}` : ''}&travelmode=driving`;
        window.open(url, '_blank');
      });

      updateDirectionsList();
      updateRouteDetails();
    });
  </script>

  </div>
</body>
</html>